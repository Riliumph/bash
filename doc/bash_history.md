# bash_historyによるコマンド実行履歴

## historyコマンド

`bash`では↑キーを使ってコマンドの実行履歴を遡ることができる。  

このhistoryコマンドは、環境変数`HISTSIZE`分のバッファを確保する。  
コマンド実行後、その成否に関わらずバッファにキューイングし続ける。  
そして、記録タイミングが来た時に`HISTFILE`へフラッシュされる。

> `HISTSIZE`のデフォルトは、環境によって異なるものの1000程度の模様。

### 記録されるタイミング

コマンドの実行履歴直後に履歴を書き込むわけではない。  
コマンドを実行すると、そのコマンドの内容が履歴バッファにキューイングされる。  
端末のセッション終了時に、バッファの内容が`HISTFILE`へフラッシュされる。

セッション終了時のフラッシュは以下の設定で無効化できる。

```bash
shopt -u histappend
```

### コマンド実行事に書き出したい場合は？

プロンプト表示前に実行される環境変数`PROMPT_COMMAND`を利用する。  

## オプション

主に使われるオプションは以下

- -a: バッファに最後に追加された内容を`HISTFILE`へ書き込む
  - バッファの状態に関わらず最後の記録を書き込むので、`HISTCONTROL`は動作しない
- -c: バッファの内容を削除する
- -r: `HISTFILE`からバッファへロードする
- -w: バッファの内容を`HISTFILE`へ書き込む
  - `-a`と異なり、`HISTCONTROL=erasedups`が機能する。

例えば、以下のような組み合わせが考えられる。

- -cr: バッファを破棄し、既存の履歴をリロードする
- -acr: 最後のバッファをフラッシュし、他のターミナル・ユーザーのフラッシュした記録もロードする
- -wcr: バッファをフラッシュし、他のターミナル・ユーザーのフラッシュした記録もロードする

## HISTFILEとは

`.bash_history`は、環境変数`HISTFILE`で管理されるbash上で実行したコマンドの保管機能・ファイルである。  
`HISTCONTROL`などによる改竄が可能であることから証跡ログとして完璧ではないものの、お手軽にコマンド実行ログとして利用できる。

## HISTCONTROLとは

`history -w`実行時に機能するオプション

- `ignorespace`: 空白で始まる行は保存されない
- `ignoredups`: 連続したコマンドは記録しない
- `erasedups`: 最新のレコードと同じレコードを削除する。（順序が入れ替わる）
  - ただし、末尾空白など余計なものが付いていると別コマンド扱いのため、思ったより綺麗にならない
  - tabキーなどで補完すると末尾空白が付くので注意
  - もはや、独自に成形した方が綺麗になるまである
